---
lab:
    az204Title: 'ラボ 05: イメージとコンテナーを使用してコンピューティング ワークロードをデプロイする'
    az204Module: 'モジュール 05: IaaS ソリューションの実装'
---

# ラボ 05: イメージとコンテナーを使用してコンピューティング ワークロードをデプロイする

## Microsoft Azure ユーザー インターフェイス

Microsoft クラウド ツールのダイナミックな特性を考えると、このトレーニング コンテンツの開発後に Azure ユーザー インターフェイスの変更が発生する可能性があります。これらの変更により、ラボの指示と手順が一致しない場合があります。

Microsoft では、コミュニティから必要な変更要望を受けたときにトレーニング コースを更新します。ただし、クラウドの更新は頻繁に行われるため、トレーニング コンテンツの更新前に UI が変更される場合もあります。**その場合は、変更に適宜対応して、ラボで要求されている内容を処理してください。**

## 手順

### 開始する前に

#### ラボの仮想マシンにログインする

次の認証情報を使用して、Windows 10 仮想マシン (VM) にログインします。
    
-   ユーザー名: **管理**

-   パスワード: **Pa55w.rd**

> **注**: 仮想ラボ環境に接続する手順は講師が説明します。

#### インストールされているアプリケーションを確認します

Windows 10 デスクトップでタスク バーを探します。タスク バーには、この課題で使用するアプリケーションのアイコンが含まれています:
    
-   Microsoft Edge

-   エクスプローラー

### 演習 1: Azure コマンド ライン インターフェイス (CLI) を使用して VM を作成する

#### タスク 1: Azure portal を開きます

1.  タスク バーで、**Microsoft Edge** アイコンを選択します。

1.  開いているブラウザー ウィンドウで、[Azure portal](<https://portal.azure.com>)に移動します。

1.  Microsoft アカウントの電子メール アドレスを入力し、**「次へ」** を選択します。

1.  Microsoft アカウントのパスワードを入力し、**「サインイン」** を選択します。

    > **注**: Azure portal に初めてサインインする場合は、ポータルのツアーが表示されます。ポータルの使用を開始するには、「**開始**」 を選択します。

#### タスク 2: リソース グループを作成する

1.  Azure portal のナビゲーション ペインで、「**リソースを作成**」 リンクを選択します。

    > **注**: **リソースの作成**リンクが見つからない場合、「**リソースの作成**」 アイコンはポータルのプラス記号(+) 文字です。

1.  「**リソースの作成**」 ブレードで、「**検索サービスとマーケットプレイス**」 テキスト ボックスを見つけます。

1.  検索ボックスに、テキスト "**Resource Group**" を入力し、Enter キーを押します。

1.  「**Marketplace**」 検索結果ブレードから、**リソース グループ**の結果を選択します。

1.  「**リソース グループ**」 ブレードから、「**作成**」 を選択します。

1.  追加の 「**リソース グループ**」 ブレードから、「**基本**」 などのブレードのタブを見つけます。

    > **注**: 各タブは、ワークフローで新しいリソース グループを作成するためのステップを表します。いつでも 「**Review + create**」 を選択して、残りのタブをスキップできます。

1.  「**基本**」 タブで、次の操作を実行します:
    
    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。
    
    1.  **リソース グループ** テキスト ボックスに、"**ContainerCompute**" を入力します。
    
    1.  「**リージョン**」 ドロップダウン リストで、「**(US) 米国東部**」 の場所を選択します。
    
    1.  「**Review + create**」 を選択します。

1.  「**Review + create**」 タブで、前の手順で選択したオプションを確認します。

1.  指定したコンフィギュレーションを使用してリソース グループを作成するには、「**作成**」 を選択します。  

    > **注**: 作成タスクが完了してから、課題を進めてください。

#### タスク 3: Azure Cloud Shell を開く

1.  Azure potalの上部で、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。

    > **注**: **Cloud Shell** アイコンは、大なり記号 () とアンダースコア文字 (\_) で表されます。

1.  サブスクリプションを使用して Cloud Shell を初めて開く場合は、**Azure Cloud Shell へようこそウィザード**を使って、初めて使用する Cloud Shell を構成できます。ウィザードで次の操作を実行します。
    
    1.  ダイアログ ボックスで、シェルを構成するように求められます。**「Bash」** を選択し、選択したサブスクリプションを確認してから、**「ストレージの作成」** を選択します。 

    > **注**: Cloud Shell が初回のセットアップ手順を完了するのを待ってから、ラボを進めます。**Cloud Shell** の構成オプションが表示されない場合、最も可能性が高い原因は、このコースのラボで既存のサブスクリプションを使用していることだと考えられます。新しいサブスクリプションを使用しているという前提で課題を記述します。

1.  ポータルの **Cloud Shell** コマンド プロンプトで次のコマンドを入力し、Enter キーを押して、Azure CLI ツールのバージョンを取得します。

    ```
    az --version
    ```

#### タスク 4: Azure CLI を使用する

1.  次のコマンドを入力し、Enter キーを押して、CLI のルート レベルにあるサブグループとコマンドの一覧を取得します。

    ```
    az --help
    ```

1.  次のコマンドを入力し、Enter キーを押して、 Azure Virtual Machines のサブグループとコマンドの一覧を取得します。

    ```
    az vm --help
    ```

1.  次のコマンドを入力し、Enter キーを押して、**仮想マシンの作成**コマンドの引数と例の一覧を取得します。

    ```
    az vm create --help
    ```

1.  次のコマンドを入力し、Enter キーを押して、次の設定で新しい**仮想マシン**を作成します。
    
    -	リソース グループ: **ContainerCompute**

    -	名前: **quickvm**

    -	イメージ: **Debian**

    -	ユーザー名: **Student**

    -	パスワード: **StudentPa55w.rd**

    ```
    az vm create --resource-group ContainerCompute --name quickvm --image Debian --admin-username student --admin-password StudentPa55w.rd
    ```

    > **注**: VM 作成のプロセスが完了するまで待ちます。プロセスが完了すると、コマンドはマシンに関する詳細を含む JSON ファイルを返します。

1.  次のコマンドを入力し、Enter を選択して、新しく作成された VM に関するさまざまなメタデータを含む詳細な JavaScript Object Notation (JSON) ファイルを取得します。

    ```
    az vm show --resource-group ContainerCompute --name quickvm
    ```

1.  次のコマンドを入力し、Enter キーを押して、VM に関連付けられているすべての IP アドレスを一覧表示します。

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm
    ```

1.  次のコマンドを入力し、Enter を選択すると、出力がフィルタリングされ、最初の IP アドレス値のみが返されます。

    ```
    az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv
    ```

1.  次のコマンドを入力し、「Enter」 を選択して、前のコマンドの結果を *ipAddress* という名前の新しい Bash シェル変数に格納します。

    ```
    ipAddress=$(az vm list-ip-addresses --resource-group ContainerCompute --name quickvm --query '[].{ip:virtualMachine.network.publicIpAddresses[0].ipAddress}' --output tsv)
    ```

1.  次のコマンドを入力し、Enter を選択して、Bash シェル変数 *ipAddress* の値をレンダリングします。

    ```
    echo $ipAddress
    ```

1.  次のコマンドを入力し、Enter を選択して、Secure Shell (SSH) ツールと Bash シェル変数 *ipAddress* に格納されている IP アドレスを使用して、この演習で前に作成した VM に接続します。

    ```
    ssh student@$ipAddress
    ```

1.  SSH ツールは、まずホストの信頼性を確立できないことを通知し、接続を続行するかどうかを確認します。「**はい**」 を入力し、Enter を選択して VM への接続を続行します。

1.  次に、SSH ツールがパスワードを要求します。 「**StudentPa55w.rd**」 を入力し、Enter を選択して VM で認証します。

1.  SSH を使用して VM に接続したら、次のコマンドを入力して Enter キーを押し、Linux VM を記述するメタデータを取得します。

    ```
    uname -a
    ```

1.  **exit** コマンドを使用して SSH セッションを終了します。

    ```
    exit
    ```

1.  ポータルの Cloud Shell ペインを閉じます。

#### レビュー

この演習では、Cloud Shell を使用して、自動化されたスクリプトの一部として VM を作成しました。

### 演習 2: Docker コンテナー イメージを作成し、Azure Container Registry にデプロイする

#### タスク 1: Cloud Shell とエディタを開く

1.  Azure portal のナビゲーション ウィンドウで、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。  

    > **注**: Cloud Shell がインスタンスへの接続を完了するまで待ってから、課題に進みます。

1.  ポータルの **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、Enter キーを選択してルート ディレクトリから **\~/clouddrive** ディレクトリに移動します。

    ```
    cd ~/clouddrive
    ```

1.  次のコマンドを入力し、Enter を選択して、**\~/clouddrive** ディレクトリ内に **ipcheck** という名前の新しいディレクトリを作成します。

    ```
    mkdir ipcheck
    ```

1.  次のコマンドを入力し、Enter を選択して、アクティブ ディレクトリを **\~/clouddrive** から **\~/clouddrive/ipcheck** に変更します。

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  次のコマンドを入力し、Enter キーを押して、現在のディレクトリに新しい .NET コンソール アプリケーションを作成します。

    ```
    dotnet new console --output . --name ipcheck
    ```

1.  次のコマンドを入力し、Enter を選択して、**\~/clouddrive/ipcheck** ディレクトリに **Dockerfile** という名前の新しいファイルを作成します。

    ```
    touch Dockerfile
    ```

1.  次のコマンドを入力し、Enter を選択して、現在のディレクトリのコンテキストで埋め込みグラフィカル エディターを開きます。

    ```
    code .
    ```

#### タスク 2: .NET アプリケーションを作成しテストする

1.  グラフィカル エディターで FILES ペインを見つけ、**Program.cs** ファイルを開いてエディターで開きます。

1.  **Program.cs** ファイルの内容全体を削除します。

1.  次のコードをコピーして **Program.cs** ファイルに貼り付けます。

    ```
    public class Program
    {
        public static void Main(string[] args)
        {        
            // Check if network is available
            if (System.Net.NetworkInformation.NetworkInterface.GetIsNetworkAvailable())
            {
                System.Console.WriteLine("Current IP Addresses:");

                // Get host entry for current hostname
                string hostname = System.Net.Dns.GetHostName();
                System.Net.IPHostEntry host = System.Net.Dns.GetHostEntry(hostname);
                
                // Iterate over each IP address and render their values
                foreach(System.Net.IPAddress address in host.AddressList)
                {
                    System.Console.WriteLine($"\t{address}");
                }
            }
            else
            {
                System.Console.WriteLine("No Network Connection");
            }
        }
    }
    ```

1.  グラフィカル エディターのメニューまたは Ctrl+S キーボード ショートカットを使用して、**Program.cs** ファイルを保存します。  グラフィカル エディターは閉じないでください。

1.  コマンド プロンプトに戻り、次のコマンドを入力し、Enter キーを押してアプリケーションを実行します。

    ```
    dotnet run
    ```

1.  実行の結果を見つけます。Cloud Shell インスタンスに対して、少なくとも 1 つの IP アドレスがリストされている必要があります。

1.  グラフィカル エディターで、エディターの FILES ペインを見つけ、**Dockerfile** ファイルを開いてエディターで開きます。

1.  次のコードをコピーして、**Dockerfile** ファイルに貼り付けます。

    ```
    # Start using the .NET Core 3.1 SDK container image
    FROM mcr.microsoft.com/dotnet/sdk:3.1-alpine AS build

    # Change current working directory
    WORKDIR /app

    # Copy existing files from host machine
    COPY . ./

    # Publish application to the "out" folder
    RUN dotnet publish --configuration Release --output out

    # Start container by running application DLL
    ENTRYPOINT ["dotnet", "out/ipcheck.dll"]
    ```

1.  グラフィカル エディターのメニューまたは Ctrl+S キーボード ショートカットを使用して、**Dockerfile** ファイルを保存します。

1.  ポータルの Cloud Shell ペインを閉じます。

#### タスク 3: コンテナー レジストリ リソースの作成

1.  Azure portal のナビゲーション ペインで、「**リソースを作成**」 リンクを選択します。

1.  「**リソースの作成**」 ブレードで、「**検索サービスとマーケットプレイス**」 テキスト ボックスを見つけます。

1.  検索ボックスに「**Container Registry**」と入力し、Enter を選択します。

1.  **Marketplace** の検索結果ブレードから、**Container Registry** の結果を選択します。

1.  **Container Registry** ブレードから、「**作成**」 を選択します。

1.  「**コンテナー レジストリの作成**」 ブレードで、次の操作を実行します。

    1.  「**レジストリ名**」 テキスト ボックスで、レジストリにグローバルに一意の名前を付けます。

        >  **注**: ブレードは名前の一意性を自動的に確認し、別の名前を選択する必要がある場合は通知します。

    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。

    1.  「**リソース グループ**」 ドロップダウン リストで、既存の 「**ContainerCompute**」 オプションを選択します。

    1.  **場所**テキスト ボックスで、**米国東部**を選択します。

    1.  **SKU** ドロップダウン リストで、**基本**を選択します。

    1.  「**Review + create**」 を選択します。  

1.  「**Review + create**」 タブで、前の手順で選択したオプションを確認します。

1.  「**作成**」 を選択し、指定した構成を使用してコンテナー レジストリを作成します。

    > **注**: 作成タスクが完了してから、課題を進めてください。

#### タスク 4: Azure Cloud Shell を開き、コンテナー レジストリ メタデータを格納する

1.  Azure potalの上部で、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。  

    > **注**: Cloud Shell がインスタンスへの接続を完了するのを待ってから、課題に進みます。

1.  ポータルの **Cloud Shell** コマンド プロンプトで次のコマンドを入力し、Enter を選択してサブスクリプション内のすべてのコンテナー レジストリの一覧を取得します。

    ```
    az acr list
    ```

1.  次のコマンドを入力してから、Enter を選択します。

    ```
    az acr list --query "max_by([], &creationDate).name" --output tsv
    ```

1.  次のコマンドを入力してから、Enter を選択します。

    ```
    acrName=$(az acr list --query "max_by([], &creationDate).name" --output tsv)
    ```

1.  次のコマンドを入力してから、Enter を選択します。

    ```
    echo $acrName
    ```

#### タスク 5: Docker コンテナー イメージをコンテナー レジストリにデプロイする

1.  次のコマンドを入力し、Enter を選択して、アクティブ ディレクトリを **\~/** から **\~/clouddrive/ipcheck** に変更します。

    ```
    cd ~/clouddrive/ipcheck
    ```

1.  次のコマンドを入力し、Enter を選択して、現在のディレクトリの内容を取得します。

    ```
    dir
    ```

1.  次のコマンドを入力し、Enter を選択してソース コードをコンテナー レジストリにアップロードし、コンテナー イメージをコンテナー レジストリ タスクとしてビルドします。

    ```
    az acr build --registry $acrName --image ipcheck:latest .
    ```

    > **注**: ビルド タスクが完了してから、演習を進めます。

1.  ポータルの Cloud Shell ペインを閉じます。

#### タスク 6: コンテナー レジストリのコンテナー イメージを検証する

1.  Azure portal のナビゲーション ペインで、「**リソース グループ**」 リンクを選択します。

1.  **リソース グループ** ブレードから、 この課題で前に作成した **ContainerCompute** リソース グループを見つけて選択します。

1.  **ContainerCompute** ブレードから、この課題で前に作成したコンテナー レジストリを選択します。

1.  「**Container Registry**」 ブレードから、「**サービス**」 セクションを見つけ、「**リポジトリ**」 リンクを選択します。

1.  **リポジトリ** セクションで、**ipcheck** コンテナー イメージ リポジトリを選択します。

1.  **リポジトリ** ブレードから、**latest** タグを選択します。

1.  **latest** タグを使用して、コンテナー イメージのバージョンのメタデータを見つけます。

    > **注**: **ID の実行**リンクを選択して、ビルド タスクに関するメタデータを検索することもできます。

#### レビュー

この演習では、マシンの現在の IP アドレスを表示する .NET コンソール アプリケーションを作成しました。次に、**Dockerfile** ファイルをアプリケーションに追加して、Docker コンテナー イメージに変換できるようにしました。最後に、コンテナー イメージをコンテナー レジストリにデプロイしました。

### 演習 3: Azure コンテナー インスタンスをデプロイする 

#### タスク 1: コンテナー レジストリで管理者ユーザーを有効にする

1.  Azure portal のナビゲーション ペインで、「**リソース グループ**」 リンクを選択します。

1.  **リソース グループ** ブレードから、 この課題で前に作成した **ContainerCompute** リソース グループを見つけて選択します。

1.  **ContainerCompute** ブレードから、この課題で前に作成したコンテナー レジストリを選択します。

1.  **Container Registry** ブレードから、**更新**を選択します。

1.  **コンテナー レジストリの更新**ブレードから、次の操作を実行します。
    
    1.   **管理者ユーザー**セクションで、**有効**を選択します。
    
    1.   「**保存**」を選択します。

    1.   ブレードを閉じます。
    
1.  **コンテナー レジストリの更新**ブレードを閉じます。

#### タスク 2: コンテナー イメージを Azure コンテナー インスタンスに自動的にデプロイする

1.  「**Container Registry**」 ブレードから、「**サービス**」 セクションを見つけ、「**リポジトリ**」 リンクを選択します。

1.  **リポジトリ** セクションで、**ipcheck** コンテナー イメージ リポジトリを選択します。

1.  **リポジトリ** ブレードから、**latest** タグ エントリに関連付けられている省略記号メニューを選択します。

1.  ポップアップ メニューで、「**インスタンスの実行**」 リンクを選択します。

1.  **コンテナー インスタンスの作成**ブレードから、次のアクションを実行します。
    
    1.  **コンテナー名**テキスト ボックスに、「**managedcompute**」と入力します。
    
    1.  **コンテナー イメージ** テキスト ボックスは、既定値のままにします。
    
    1.  「**OSの種類**」 セクションから、「**Linux**」 を選択します。
    
    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。
    
    1.  「**リソース グループ**」 ドロップダウン リストで、「**ContainerCompute**」 を選択します。
    
    1.  **場所**ドロップダウン リストで、**米国東部**を選択します。
    
    1.  「**コア数**」 ドロップダウン リストで、「**2**」 を選択します。
    
    1.  「**メモリ (GB)**」 テキスト ボックスに「**4**」を入力します。
    
    1.  **パブリック IP アドレス** セクションで**いいえ**を選択します。
    
    1.  「**OK**」を選択します。

    > **注**: 作成タスクが完了してから、課題を進めてください。

#### タスク 3: コンテナー イメージを コンテナー インスタンスに手動でデプロイする

1.  Azure portal のナビゲーション ペインで、「**リソースを作成**」 リンクを選択します。

1.  「**リソースの作成**」 ブレードで、「**検索サービスとマーケットプレイス**」 テキスト ボックスを見つけます。

1.  検索ボックスに「**container instances**」と入力し、Enter キーを押します。

1.  **Marketplace** 検索結果ブレードから、**Container Instances** の結果を選択します。

1.  「**コンテナー インスタンス**」 ブレードから、「**作成**」 を選択します。

1.  「**コンテナー インスタンスの作成**」 ブレードから、「**基本**」、「**ネットワーク**」、「**詳細**」 などのタブを見つけます。

    > **注**: 各タブは、ワークフローで新しいコンテナー インスタンスを作成するためのステップを表します。

1.  「**基本**」 タブで、次の操作を実行します:

    1.  「**サブスクリプション**」 テキスト ボックスは既定値のままにします。

    1.  「**リソース グループ**」 ドロップダウン リストで、「**ContainerCompute**」 を選択します。
    
    1.  「**コンテナー名**」 テキスト ボックスに、「**manualcompute**」と入力します。

    1.  「**リージョン**」 ドロップダウン リストで、「**(US) 米国東部**」 を選択します。
    
    1.  「**イメージのソース**」 セクションで、「**Azure Container Registry**」 を選択します。
    
    1.  「**レジストリ**」 ドロップダウン リストで、 このラボで前に作成した 「**Azure Container Registry**」 リソースを選択します。
    
    1.  「**イメージ**」 ドロップダウン リストで、「**ipcheck**」 を選択します。
    
    1.  「**イメージ タグ**」 ドロップダウン リストで、「**最新**」 を選択します。

    1.  「**Review + create**」 を選択します。

1.  「**Review + create**」 タブで、選択したオプションを確認します。

1.  「**作成**」 を選択し、指定した構成を使用してコンテナー インスタンスを作成します。  

    > **注**: 作成タスクが完了してから、課題を進めてください。

#### タスク 4: コンテナー インスタンスを正常に実行したことを確認する

1.  Azure portal のナビゲーション ペインで、「**リソース グループ**」 リンクを選択します。

1.  **リソース グループ** ブレードから、 この課題で前に作成した **ContainerCompute** リソース グループを見つけて選択します。

1.  「**ContainerCompute**」 ブレードから、この課題で前に作成した **manualcompute** コンテナー インスタンスを選択します。

1.  **コンテナー インスタンス** ブレードから、**設定**セクションを見つけて、**コンテナー** リンクを選択します。

1.  「**コンテナー**」 セクションで、**イベント**の一覧を見つけます。

1.  「**ログ**」 タブを選択して、コンテナー インスタンスのテキスト ログを確認します。

> **注**: 必要に応じて、**managedcompute** コンテナー インスタンスから**イベント**と**ログ**を表示することもできます。

> **注**: アプリケーションの実行が完了すると、コンテナーは作業を完了したため終了します。手動で作成されたコンテナー インスタンスの場合、正常な終了が許容されたため、コンテナーは 1 回実行されます。自動的に作成されたインスタンスではこのオプションは提供されず、コンテナーは常に実行されていることを前提としているため、コンテナーの再起動が繰り返されます。

#### レビュー

この演習では、複数のメソッドを使用して、コンテナー イメージを Azure コンテナー インスタンスにデプロイしました。手動のメソッドを使用すると、デプロイをさらにカスタマイズし、コンテナーの実行の一部としてタスク ベースのアプリケーションを実行することもできます。

### 演習 4: サブスクリプションのクリーンアップ 

#### タスク 1: Azure Cloud Shellを開き、リソース グループを一覧表示する

1.  Azure portal のナビゲーション ウィンドウで、**Cloud Shell** アイコンを選択して新しいシェル インスタンスを開きます。

    > **注**: **Cloud Shell** アイコンは、大なり記号 () とアンダースコア文字 (\_) で表されます。

1.  サブスクリプションを使用して Cloud Shell を初めて開く場合は、**Azure Cloud Shell へようこそウィザード**を使って、初めて使用する Cloud Shell を構成できます。ウィザードで次の操作を実行します。
    
    1.  ダイアログ ボックスで、シェルを構成するように求められます。**「Bash」** を選択し、選択したサブスクリプションを確認してから、**「ストレージの作成」** を選択します。 

    > **注**: Cloud Shell が初回のセットアップ手順を完了するのを待ってから、ラボを進めます。Cloud Shell の構成オプションが表示されない場合は、このコースのラボで既存のサブスクリプションを使用している可能性が高いと考えられます。ラボは、新しいサブスクリプションを使用しているという前提で記述されます。

#### タスク 2: リソース グループを削除する

1.  次のコマンドを入力して Enter キーを押し、**ContainerCompute** リソース グループを削除します。

    ```
    az group delete --name ContainerCompute --no-wait --yes
    ```

1.  ポータルの Cloud Shell ペインを閉じます。

#### タスク 3: アクティブなアプリケーションを閉じる

-   現在実行中の Microsoft Edge アプリケーションを閉じます。

#### レビュー

この実習では、このラボで使用するリソース グループを削除することで、サブスクリプションをクリーンアップしました。
