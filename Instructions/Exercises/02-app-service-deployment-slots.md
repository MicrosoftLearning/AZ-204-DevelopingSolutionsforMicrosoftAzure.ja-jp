---
lab:
  title: Azure App Service 内でデプロイ スロットを入れ替える
  description: Azure App Service 内でデプロイ スロットを入れ替える方法を学習します。 この演習では、単純なアプリを App Service にデプロイして小さな変更を加え、ステージング スロットにデプロイします。最後にスロットを入れ替えて、更新されたアプリが運用環境に入るようにします。
---

# Azure App Service 内でデプロイ スロットを入れ替える

この演習では、Azure CLI **az webapp up** コマンドを使用し、基本的な HTML+CSS サイトを Azure App Service にデプロイします。 次に、コードを更新し、変更をステージング スロットにデプロイします。 最後に、スロットを入れ替えます。

この演習で実行されるタスク:

* サンプル アプリをダウンロードして Azure App Service にデプロイします。
* ステージング デプロイ スロットを作成します。
* サンプル アプリに変更を加え、ステージング スロットにデプロイします。
* ステージング スロットと既定の運用スロットを入れ替えて、変更内容を運用スロット内に導入します。

この演習の所要時間は約 **20** 分です。

## 開始する前に

演習を完了するには、次のリソースが必要です。

* Azure サブスクリプション。 サブスクリプションをお持ちでない場合は、[https://azure.microsoft.com/](https://azure.microsoft.com/) にサインアップして作成してください。

## サンプル アプリのダウンロードとデプロイ

このセクションでは、サンプル アプリをダウンロードし、コマンドを入力しやすいよう変数を設定した後、Azure CLI コマンドを使用して Azure App Service リソースを作成し、静的 HTML サイトをデプロイします。

1. お使いのブラウザーで Azure portal ([https://portal.azure.com](https://portal.azure.com)) に移動し、メッセージに応じて Azure 資格情報を使用してサインインします。

1. ページ上部の検索バーの右側にある **[\>_]** ボタンを使用して、Azure portal 内に新しいクラウド シェルを作成します。***Bash*** 環境を選択すること。 Azure portal の下部にあるペインに、Cloud Shell のコマンド ライン インターフェイスが表示されます。

    > **注**: *PowerShell* 環境を使用するクラウド シェルを以前に作成している場合は、それを ***Bash*** に切り替えること。

1. Cloud Shell ツール バーの **[設定]** メニューで、**[クラシック バージョンに移動]** を選択します (これはコード エディターを使用するのに必要です)。

1. 以下の **git** コマンドを実行してサンプル アプリ レポジトリを複製します。

    ```bash
    git clone https://github.com/Azure-Samples/html-docs-hello-world.git
    ```

1. 次のコマンドを実行し、リソース グループとアプリ名を保持する変数を設定します。 コマンド実行後に表示される **appName** の値をメモしておきます。この演習の後半で必要になります。

    ```bash
    resourceGroup=rg-mywebapp

    appName=mywebapp$RANDOM
    echo $appName
    ```

1. サンプル コードが含まれているディレクトリに移動し、**[az webapp up]** コマンドを実行します。 **注:** このコマンドの実行には数分かかることがあります。

    ```bash
    cd html-docs-hello-world

    az webapp up -g $resourceGroup -n $appName --sku P0V3 --html
    ```

    デプロイが完了したので、ここで Web アプリを表示してみましょう。

1. Azure portal 内で、デプロイした Web アプリに移動します。 前の手順でメモしておいた名前を **[Search resources, services, and docs (G + /)]** 検索バーに入力し、表示される一覧からリソースを選択してください。

1. **Essentials** セクションの **Default domain** フィールドにある Web アプリへのリンクを選択します。 リンクをクリックすると、サイトが新しいタブで開きます。

## デプロイ スロットに更新されたコードをデプロイする

このセクションでは、デプロイ スロットを作成し、アプリ内で HTML を変更し、更新されたコードを新しいデプロイ スロットにデプロイします。

### デプロイ スロットを作成する 

1. Azure portal と クラウド シェルのタブに戻ります。

1. クラウド シェル内で以下のコマンドを入力して、*[staging]* と言う名前のデプロイ スロットを作成します。

    ```bash
    az webapp deployment slot create -n $appName -g $resourceGroup --slot staging
    ```

1. コマンドが完了するのを待ってから、左側のメニューで **[Deployment] > [Deployment slots]** の順に選択し、Web アプリのデプロイ スロットを表示します。 新しいスロットの名前は、web アプリ名の後に*staging* の文字列が含まれています。

### コードを更新し、ステージング スロットにデプロイする

1. クラウド シェル内で「`code index.html`」と入力してエディターを開きます。 `<h1>` 見出しタグで、*"Azure App Service - Sample Static HTML Site"* を、*"Azure App Service Staging Slot"* または他の任意の文字列に変更します。

1. コマンド **Ctrl+s** キーを使用して保存し、**Ctrl+q** キーで終了します。

1. Cloud Shell で次のコマンドを実行して、更新されたプロジェクトの zip ファイルを作成します。 次の手順では、zip ファイルまたは Web アプリケーション リソース (WAR) ファイルが必要です。

    ```bash
    zip -r stagingcode.zip .
    ```

1. Cloud Shell で次のコマンドを実行して、ステージング スロットに更新プログラムをデプロイします。

    ```bash
    az webapp deploy -g $resourceGroup -n $appName --src-path ./stagingcode.zip --slot staging
    ```

1. Web アプリの左側のメニューで **[デプロイ]、[デプロイ スロット]** を選択し、前に作成したステージング スロットを選択します。

1. **Essentials** セクションの **[Default domain]** フィールドのリンクを選択します。 リンクにより、ステージング スロットの Web サイトが新しいタブで開きます。

## ステージング スロットと運用スロットをスワップします。

Azure portal では、ツール バーの **[Swap]** オプションを使用してスワップを実行できます。 左側のメニューで **[Swap]** オプションがツール バーに表示されるのは、 **[Overview]** または **[Deployment]、[Deployment slots]** を選択した場合です。

1. Azure portal で、ツール バーの **[Swap]** を選択して、**[Swap]** パネルを開きます。

1. スワップ パネルの設定を確認します。 **ソース**には**ステージング** スロットが表示され、**ターゲット**には既定の運用スロットが表示されます。

    ![[スワップ] パネルのスクリーンショット。](./media/02/app-service-swap-panel.png)

1. **[スワップの開始]** を選び、処理が完了するまで待ちます。 **[通知]** パネルで完了を追跡できます。このパネルを開くには、ポータルの上部にあるベル アイコンを選択します。

1. スワップを確認するには、デプロイした Web アプリに移動します。 前に作成した Web アプリ名 (*mywebapp12360* など) を **リソース、サービス、ドキュメントの検索 (G+/)** 検索バーに入力し、一覧からリソースを選択します。

1. **Essentials** セクションの **Default domain** フィールドにある Web アプリへのリンクを選択します。 リンクにより、サイト (運用スロット) が新しいタブで開きます。

1. 変更を確認します。ページを更新して表示する必要がある場合があります。

## リソースをクリーンアップする

これで演習が完了したので、不要なリソース使用を避けるために、作成したクラウド リソースを削除してください。

1. 作成したリソース グループに移動し、この演習で使用したリソースの内容を表示します。
1. ツール バーの **[リソース グループの削除]** を選びます。
1. リソース グループ名を入力し、削除することを確認します。
